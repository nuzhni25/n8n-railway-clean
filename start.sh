#!/bin/bash

echo "üöÄ –ó–∞–ø—É—Å–∫ n8n —Å SQLite..."

# URL –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π —Å—Ä–µ–¥—ã –∏–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
DATABASE_URL="${DATABASE_URL:-https://file.kiwi/33ccc9a6#0TVv_YEMbV2tWaivXh5dBA}"

# –ü—É—Ç—å –∫ –¥–∞–Ω–Ω—ã–º (–∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–æ–º–∞—à–Ω—é—é –ø–∞–ø–∫—É –≤–º–µ—Å—Ç–æ /data)
DATA_PATH="/home/node/data"
DB_PATH="$DATA_PATH/database.sqlite"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ–Ω–µ
download_database() {
    echo "üîÑ –ù–∞—á–∏–Ω–∞–µ–º —Ñ–æ–Ω–æ–≤—É—é –∑–∞–≥—Ä—É–∑–∫—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
    
    # –ñ–¥–µ–º –ø–æ–∫–∞ n8n –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
    sleep 30
    
    # –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    for i in 1 2 3; do
        echo "üì• –ü–æ–ø—ã—Ç–∫–∞ $i –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        TEMP_FILE="$DATA_PATH/database_temp.sqlite"
        
        if curl -L --fail --connect-timeout 60 --max-time 1800 \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            -H "Accept: */*" \
            --progress-bar \
            -o "$TEMP_FILE" \
            "$DATABASE_URL"; then
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
            DOWNLOADED_SIZE=$(stat -c%s "$TEMP_FILE" 2>/dev/null || stat -f%z "$TEMP_FILE" 2>/dev/null || echo 0)
            DOWNLOADED_MB=$((DOWNLOADED_SIZE / 1024 / 1024))
            
            echo "üìä –†–∞–∑–º–µ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞: $DOWNLOADED_MB MB"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–æ–ª—å—à–æ–π (–º–∏–Ω–∏–º—É–º 100MB)
            if [ "$DOWNLOADED_SIZE" -gt 104857600 ]; then
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞ –ø–æ magic numbers
                FILE_TYPE=$(file -b "$TEMP_FILE" | head -1)
                echo "üìã –¢–∏–ø —Ñ–∞–π–ª–∞: $FILE_TYPE"
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ñ–∞–π–ª —Å–∂–∞—Ç—ã–º
                if echo "$FILE_TYPE" | grep -qi "gzip"; then
                    echo "üì¶ –û–±–Ω–∞—Ä—É–∂–µ–Ω —Å–∂–∞—Ç—ã–π —Ñ–∞–π–ª, —Ä–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º..."
                    if gunzip -c "$TEMP_FILE" > "$DB_PATH.tmp"; then
                        mv "$DB_PATH.tmp" "$DB_PATH"
                        echo "‚úÖ –°–∂–∞—Ç–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω–∞!"
                    else
                        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–µ —Å–∂–∞—Ç–æ–≥–æ —Ñ–∞–π–ª–∞"
                        continue
                    fi
                else
                    # –§–∞–π–ª –Ω–µ —Å–∂–∞—Ç, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–º–µ—â–∞–µ–º
                    mv "$TEMP_FILE" "$DB_PATH"
                    echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–≥—Ä—É–∂–µ–Ω–∞!"
                fi
                
                echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º n8n —Å –Ω–æ–≤–æ–π –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö..."
                
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∏–≥–Ω–∞–ª –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ n8n
                pkill -f "n8n"
                
                return 0
            else
                echo "‚ö†Ô∏è –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π: $DOWNLOADED_MB MB, –æ–∂–∏–¥–∞–µ–º –º–∏–Ω–∏–º—É–º 100MB"
                rm -f "$TEMP_FILE"
            fi
        else
            echo "‚ùå –ü–æ–ø—ã—Ç–∫–∞ $i –Ω–µ —É–¥–∞–ª–∞—Å—å"
        fi
        
        if [ $i -lt 3 ]; then
            echo "‚è≥ –ñ–¥–µ–º 60 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π..."
            sleep 60
        fi
    done
    
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫"
}

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
echo "üìÅ –°–æ–∑–¥–∞–µ–º —Ä–∞–±–æ—á–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏..."
mkdir -p "$DATA_PATH/.n8n"

# –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
if [ ! -f "$DB_PATH" ]; then
    echo "üìù –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞..."
    touch "$DB_PATH" && echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞" || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
fi

echo "üíæ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–∑: $DB_PATH"
echo "üåê n8n –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 5678"

# –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ–Ω–µ
download_database &

# –ó–∞–ø—É—Å–∫–∞–µ–º n8n
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º n8n..."
exec n8n start 