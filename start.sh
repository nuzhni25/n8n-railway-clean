#!/bin/bash

echo "üöÄ –ó–∞–ø—É—Å–∫ n8n —Å SQLite..."

# –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ root –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å —Ñ–∞–π–ª–∞–º–∏
if [ "$(id -u)" != "0" ]; then
    exec su-exec root "$0" "$@"
fi

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
mkdir -p /data
chown node:node /data

# URL –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π —Å—Ä–µ–¥—ã –∏–ª–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
DATABASE_URL="${DATABASE_URL:-https://file.kiwi/33ccc9a6#0TVv_YEMbV2tWaivXh5dBA}"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ–Ω–µ
download_database() {
    echo "üîÑ –ù–∞—á–∏–Ω–∞–µ–º —Ñ–æ–Ω–æ–≤—É—é –∑–∞–≥—Ä—É–∑–∫—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
    
    # –ñ–¥–µ–º –ø–æ–∫–∞ n8n –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
    sleep 30
    
    # –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    for i in 1 2 3; do
        echo "üì• –ü–æ–ø—ã—Ç–∫–∞ $i –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
        
        if curl -L --fail --connect-timeout 60 --max-time 1800 \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            -H "Accept: */*" \
            --progress-bar \
            -o /data/database_new.sqlite \
            "$DATABASE_URL"; then
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
            FILE_SIZE=$(stat -f%z /data/database_new.sqlite 2>/dev/null || stat -c%s /data/database_new.sqlite 2>/dev/null || echo 0)
            echo "üìä –†–∞–∑–º–µ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞: $(($FILE_SIZE / 1024 / 1024)) MB"
            
            if [ "$FILE_SIZE" -gt 500000000 ]; then
                echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–≥—Ä—É–∂–µ–Ω–∞! –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º n8n..."
                # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º n8n, –∑–∞–º–µ–Ω—è–µ–º –±–∞–∑—É –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º
                pkill -f "n8n"
                sleep 5
                mv /data/database_new.sqlite /data/database.sqlite
                chown node:node /data/database.sqlite
                chmod 644 /data/database.sqlite
                echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º n8n —Å –Ω–æ–≤–æ–π –±–∞–∑–æ–π..."
                su-exec node n8n &
                break
            else
                echo "‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π, –ø–æ–≤—Ç–æ—Ä—è–µ–º..."
                rm -f /data/database_new.sqlite
            fi
        else
            echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏, –ø–æ–ø—ã—Ç–∫–∞ $i"
            rm -f /data/database_new.sqlite
        fi
        
        if [ $i -lt 3 ]; then
            echo "‚è≥ –ñ–¥–µ–º 60 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π..."
            sleep 60
        fi
    done
    
    if [ ! -f "/data/database.sqlite" ] || [ $(stat -f%z /data/database.sqlite 2>/dev/null || stat -c%s /data/database.sqlite 2>/dev/null || echo 0) -lt 500000000 ]; then
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö"
        echo "‚ÑπÔ∏è  n8n –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –ø—É—Å—Ç–æ–π –±–∞–∑–æ–π"
    fi
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
if [ ! -f "/data/database.sqlite" ]; then
    echo "üìù –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø—É—Å—Ç—É—é –±–∞–∑—É –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞..."
    touch /data/database.sqlite
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –≤ —Ñ–æ–Ω–µ
    download_database &
    
    echo "‚ÑπÔ∏è  n8n –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å –ø—É—Å—Ç–æ–π –±–∞–∑–æ–π, –ø–æ–ª–Ω–∞—è –±–∞–∑–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ —Ñ–æ–Ω–µ..."
else
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –±–∞–∑—ã
    CURRENT_SIZE=$(stat -f%z /data/database.sqlite 2>/dev/null || stat -c%s /data/database.sqlite 2>/dev/null || echo 0)
    if [ "$CURRENT_SIZE" -lt 500000000 ]; then
        echo "üìù –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–ø–æ–ª–Ω–∞—è ($(($CURRENT_SIZE / 1024 / 1024)) MB), –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é –≤ —Ñ–æ–Ω–µ..."
        download_database &
    else
        echo "‚úÖ –ü–æ–ª–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ($(($CURRENT_SIZE / 1024 / 1024)) MB)"
    fi
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª—ã
chown -R node:node /data
chmod 644 /data/database.sqlite

echo "üéØ –ó–∞–ø—É—Å–∫–∞–µ–º n8n..."
echo "üåê –ë—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ –ø–æ—Ä—Ç—É 5678"
echo "‚ÑπÔ∏è  –ï—Å–ª–∏ –±–∞–∑–∞ –ø—É—Å—Ç–∞—è, –ø–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–∏–Ω—É—Ç"

# –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è node –∏ –∑–∞–ø—É—Å–∫–∞–µ–º n8n
exec su-exec node n8n 