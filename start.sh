#!/bin/bash

echo "üöÄ –ó–∞–ø—É—Å–∫ n8n —Å SQLite..."

# URL –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö - –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –°–°–´–õ–ö–ê!
DATABASE_URL="${DATABASE_URL:-https://file.kiwi/261a4bdd#5S4OrcMlo5apvO3PvU6c0A}"

# –ü—É—Ç—å –∫ –¥–∞–Ω–Ω—ã–º (–∏—Å–ø–æ–ª—å–∑—É–µ–º Railway Volume)
DATA_PATH="/data"
DB_PATH="$DATA_PATH/database.sqlite"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
fix_permissions() {
    echo "üîß –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞..."
    
    # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
    mkdir -p "$DATA_PATH/.n8n" 2>/dev/null || true
    
    # –ü—ã—Ç–∞–µ–º—Å—è –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –∫–∞–∫ root –µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ
    if [ "$(id -u)" = "0" ]; then
        chown -R node:node "$DATA_PATH" 2>/dev/null || true
        chmod -R 755 "$DATA_PATH" 2>/dev/null || true
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –Ω–∞ –∑–∞–ø–∏—Å—å
    if [ ! -w "$DATA_PATH" ]; then
        echo "‚ö†Ô∏è –ù–µ—Ç –ø—Ä–∞–≤ –∑–∞–ø–∏—Å–∏ –≤ $DATA_PATH, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–æ–º–∞—à–Ω—é—é –ø–∞–ø–∫—É"
        DATA_PATH="/home/node/data"
        DB_PATH="$DATA_PATH/database.sqlite"
        mkdir -p "$DATA_PATH/.n8n"
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—ã
        export DB_SQLITE_DATABASE="$DB_PATH"
        export N8N_USER_FOLDER="$DATA_PATH/.n8n"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ–Ω–µ
download_database() {
    echo "üîÑ –ù–∞—á–∏–Ω–∞–µ–º —Ñ–æ–Ω–æ–≤—É—é –∑–∞–≥—Ä—É–∑–∫—É ZIP –∞—Ä—Ö–∏–≤–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
    
    # –ñ–¥–µ–º –ø–æ–∫–∞ n8n –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
    sleep 30
    
    # –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞—Ä—Ö–∏–≤
    for i in 1 2 3; do
        echo "üì¶ –ü–æ–ø—ã—Ç–∫–∞ $i –∑–∞–≥—Ä—É–∑–∫–∏ ZIP –∞—Ä—Ö–∏–≤–∞..."
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –∞—Ä—Ö–∏–≤–∞
        TEMP_ARCHIVE="$DATA_PATH/database.zip"
        
        if curl -L --fail --connect-timeout 60 --max-time 1800 \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            -H "Accept: */*" \
            --progress-bar \
            -o "$TEMP_ARCHIVE" \
            "$DATABASE_URL"; then
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –∏ –∏–º–µ–µ—Ç —Ä–∞–∑—É–º–Ω—ã–π —Ä–∞–∑–º–µ—Ä (–º–∏–Ω–∏–º—É–º 10MB –¥–ª—è ZIP)
            if [ -f "$TEMP_ARCHIVE" ]; then
                FILE_SIZE=$(stat -c%s "$TEMP_ARCHIVE" 2>/dev/null || echo 0)
                FILE_SIZE_MB=$((FILE_SIZE / 1024 / 1024))
                
                echo "üìä –†–∞–∑–º–µ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –∞—Ä—Ö–∏–≤–∞: ${FILE_SIZE_MB}MB"
                
                if [ "$FILE_SIZE" -gt 10485760 ]; then # > 10MB
                    echo "‚úÖ –ê—Ä—Ö–∏–≤ –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ, –Ω–∞—á–∏–Ω–∞–µ–º —Ä–∞—Å–ø–∞–∫–æ–≤–∫—É..."
                    
                    # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –∞—Ä—Ö–∏–≤
                    if unzip -q "$TEMP_ARCHIVE" -d "$DATA_PATH/"; then
                        echo "üìÇ –ê—Ä—Ö–∏–≤ —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω"
                        
                        # –ò—â–µ–º —Ñ–∞–π–ª database.sqlite –≤ —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö
                        EXTRACTED_DB=$(find "$DATA_PATH" -name "database.sqlite" -type f | head -1)
                        
                        if [ -n "$EXTRACTED_DB" ] && [ -f "$EXTRACTED_DB" ]; then
                            echo "üóÑÔ∏è –ù–∞–π–¥–µ–Ω–∞ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: $EXTRACTED_DB"
                            
                            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω–Ω–æ–π –±–∞–∑—ã
                            DB_SIZE=$(stat -c%s "$EXTRACTED_DB" 2>/dev/null || echo 0)
                            DB_SIZE_MB=$((DB_SIZE / 1024 / 1024))
                            
                            echo "üìä –†–∞–∑–º–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: ${DB_SIZE_MB}MB"
                            
                            if [ "$DB_SIZE" -gt 52428800 ]; then # > 50MB
                                echo "üîÑ –ó–∞–º–µ–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö..."
                                
                                # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º n8n –ø—Ä–æ—Ü–µ—Å—Å
                                pkill -f "n8n"
                                sleep 5
                                
                                # –î–µ–ª–∞–µ–º –±—ç–∫–∞–ø —Å—Ç–∞—Ä–æ–π –±–∞–∑—ã
                                if [ -f "$DB_PATH" ]; then
                                    mv "$DB_PATH" "$DB_PATH.backup"
                                fi
                                
                                # –ü–µ—Ä–µ–º–µ—â–∞–µ–º –Ω–æ–≤—É—é –±–∞–∑—É –Ω–∞ –º–µ—Å—Ç–æ
                                mv "$EXTRACTED_DB" "$DB_PATH"
                                
                                # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –Ω–æ–≤—É—é –±–∞–∑—É
                                chmod 644 "$DB_PATH" 2>/dev/null || true
                                
                                # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
                                rm -f "$TEMP_ARCHIVE"
                                
                                echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!"
                                echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º n8n..."
                                
                                # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º n8n
                                exec n8n start
                            else
                                echo "‚ö†Ô∏è –†–∞–∑–º–µ—Ä —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω–Ω–æ–π –±–∞–∑—ã —Å–ª–∏—à–∫–æ–º –º–∞–ª: ${DB_SIZE_MB}MB"
                            fi
                        else
                            echo "‚ùå –§–∞–π–ª database.sqlite –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∞—Ä—Ö–∏–≤–µ"
                        fi
                    else
                        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–µ –∞—Ä—Ö–∏–≤–∞"
                    fi
                else
                    echo "‚ö†Ô∏è –†–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞ —Å–ª–∏—à–∫–æ–º –º–∞–ª: ${FILE_SIZE_MB}MB"
                fi
            fi
            
            # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–∏ –æ—à–∏–±–∫–µ
            rm -f "$TEMP_ARCHIVE"
            break
        else
            echo "‚ùå –ü–æ–ø—ã—Ç–∫–∞ $i –Ω–µ—É–¥–∞—á–Ω–∞"
            if [ $i -lt 3 ]; then
                echo "‚è≥ –ñ–¥–µ–º 60 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π..."
                sleep 60
            fi
        fi
    done
    
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞—Ä—Ö–∏–≤ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫"
}

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
fix_permissions

# –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞
if [ ! -f "$DB_PATH" ]; then
    echo "üìù –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞..."
    touch "$DB_PATH" 2>/dev/null || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª –±–∞–∑—ã"
fi

echo "üéØ –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Ç—å: $DATA_PATH"
echo "üéØ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: $DB_PATH"
echo "üéØ n8n –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å –ø—É—Å—Ç–æ–π –±–∞–∑–æ–π, –ø–æ–ª–Ω–∞—è ZIP –±–∞–∑–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ —Ñ–æ–Ω–µ..."

# –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ–Ω–µ
download_database &

# –ó–∞–ø—É—Å–∫–∞–µ–º n8n
exec n8n start 