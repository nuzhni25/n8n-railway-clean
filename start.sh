#!/bin/bash

echo "üöÄ Starting n8n with Railway Volume database copy..."

# üéØ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –ë–ê–ó–´ –ò–ó VOLUME 
# –ü—Ä–æ–±–ª–µ–º–∞: –±–∞–∑–∞ –≤ /app/database.sqlite –Ω–æ n8n –Ω–µ –º–æ–∂–µ—Ç –µ—ë –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–∑-–∑–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
# –†–µ—à–µ–Ω–∏–µ: –∫–æ–ø–∏—Ä—É–µ–º –±–∞–∑—É –≤ /home/node/.n8n/database.sqlite –≥–¥–µ n8n –º–æ–∂–µ—Ç —Å –Ω–µ–π —Ä–∞–±–æ—Ç–∞—Ç—å

# üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è node
echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π..."
if [ "$(whoami)" = "root" ]; then
    echo "‚úÖ –†–∞–±–æ—Ç–∞–µ–º –æ—Ç root - –º–æ–∂–µ–º –∏—Å–ø—Ä–∞–≤–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è"
    chown -R 1000:1000 /app/ 2>/dev/null || echo "‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Railway –¥–ª—è /app/"
    chmod -R 755 /app/ 2>/dev/null || echo "‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Railway –¥–ª—è /app/"
else
    echo "‚ö†Ô∏è –ù–µ root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $(whoami)"
fi

# üéØ –ü–æ–∏—Å–∫ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ Railway Volume
echo "üéØ –ü–æ–∏—Å–∫ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ Railway Volume..."
VOLUME_DB="/app/database.sqlite"
TARGET_DB="/home/node/.n8n/database.sqlite"

# üìÅ –°–æ–∑–¥–∞–Ω–∏–µ —Ü–µ–ª–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è n8n..."
mkdir -p /home/node/.n8n
chown -R 1000:1000 /home/node/.n8n 2>/dev/null || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞"
chmod -R 755 /home/node/.n8n 2>/dev/null || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –ø—Ä–∞–≤–∞"

if [ -f "$VOLUME_DB" ]; then
    echo "‚úÖ –ë–∞–∑–∞ –Ω–∞–π–¥–µ–Ω–∞ –≤ Volume: $VOLUME_DB"
    echo "üìä –†–∞–∑–º–µ—Ä –±–∞–∑—ã –≤ Volume: $(du -h "$VOLUME_DB" | cut -f1)"
    
    # üîÑ –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –ë–ê–ó–´
    echo "üîÑ –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –±–∞–∑—ã –∏–∑ Volume –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é..."
    echo "   –ò—Å—Ç–æ—á–Ω–∏–∫: $VOLUME_DB"
    echo "   –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: $TARGET_DB"
    
    # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
    cp "$VOLUME_DB" "$TARGET_DB" 2>/dev/null
    COPY_RESULT=$?
    
    if [ $COPY_RESULT -eq 0 ] && [ -f "$TARGET_DB" ]; then
        echo "‚úÖ –ë–∞–∑–∞ –£–°–ü–ï–®–ù–û —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!"
        echo "üìä –†–∞–∑–º–µ—Ä —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –±–∞–∑—ã: $(du -h "$TARGET_DB" | cut -f1)"
        
        # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –±–∞–∑—ã
        chown 1000:1000 "$TARGET_DB" 2>/dev/null || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ –±–∞–∑—ã"
        chmod 664 "$TARGET_DB" 2>/dev/null || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –ø—Ä–∞–≤–∞ –±–∞–∑—ã"
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –±–∞–∑—ã
        if command -v sqlite3 >/dev/null 2>&1; then
            TABLE_COUNT=$(sqlite3 "$TARGET_DB" "SELECT COUNT(*) FROM sqlite_master WHERE type='table';" 2>/dev/null || echo "0")
            echo "üìã –¢–∞–±–ª–∏—Ü –≤ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –±–∞–∑–µ: $TABLE_COUNT"
            
            if [ "$TABLE_COUNT" -gt 5 ]; then
                echo "üéâ –ë–∞–∑–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ - –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!"
                USE_COPIED_DB="YES"
            else
                echo "‚ö†Ô∏è –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –±–∞–∑–∞ –ø—É—Å—Ç–∞—è"
            fi
        fi
    else
        echo "‚ùå –û–®–ò–ë–ö–ê –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –±–∞–∑—ã!"
        echo "–°–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –±–∞–∑—É..."
    fi
else
    echo "‚ùå –ë–∞–∑–∞ –ù–ï –Ω–∞–π–¥–µ–Ω–∞ –≤ Volume: $VOLUME_DB"
    echo "–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –±–∞–∑–∞..."
fi

# üîë –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –∫–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
echo "üîë –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–ª—é—á–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è..."
export N8N_ENCRYPTION_KEY="GevJ653kDGJTiemfO4SynmyQEMRwyL/X"

# üßπ –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
echo "üßπ –û—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
unset DB_SQLITE_DATABASE
unset N8N_DATABASE_SQLITE_DATABASE 
unset N8N_DB_SQLITE_DATABASE
unset SQLITE_DATABASE
unset DB_TYPE
unset N8N_DATABASE_TYPE
unset N8N_DB_TYPE

# üéØ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¢–û–õ–¨–ö–û –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –±–∞–∑—ã
echo "üéØ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
export DB_TYPE="sqlite"
export DB_SQLITE_DATABASE="$TARGET_DB"
export N8N_DATABASE_SQLITE_DATABASE="$TARGET_DB"
export N8N_USER_FOLDER="/home/node/.n8n"

# üö´ –û–¢–ö–õ–Æ–ß–ï–ù–ò–ï –≠–ö–†–ê–ù–ê –ù–ê–°–¢–†–û–ô–ö–ò
echo "üö´ –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏..."
export N8N_OWNER_DISABLED="true"
export N8N_DISABLE_SETUP_UI="true"

# ‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è SQLite
echo "‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è SQLite..."
export N8N_DATABASE_SQLITE_ENABLE_WAL="false"
export N8N_DATABASE_SQLITE_VACUUM_ON_STARTUP="false"

# üìä –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
echo "üìä –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞..."
echo "üóÉÔ∏è –ü—É—Ç—å –∫ –±–∞–∑–µ: $DB_SQLITE_DATABASE"
echo "üìÅ –ë–∞–∑–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: $([ -f "$DB_SQLITE_DATABASE" ] && echo "‚úÖ –î–ê" || echo "‚ùå –ù–ï–¢")"
echo "üìä –ë–∞–∑–∞ —á–∏—Ç–∞–µ–º–∞—è: $([ -r "$DB_SQLITE_DATABASE" ] && echo "‚úÖ –î–ê" || echo "‚ùå –ù–ï–¢")"

# üîÑ –û–ñ–ò–î–ê–ù–ò–ï –ü–û–õ–ù–û–ì–û –ö–û–ü–ò–†–û–í–ê–ù–ò–Ø
echo "üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –±–∞–∑–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–∞—Å—å..."
if [ -f "$DB_SQLITE_DATABASE" ]; then
    FINAL_SIZE=$(stat -c%s "$DB_SQLITE_DATABASE" 2>/dev/null || echo "0")
    echo "üìä –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –±–∞–∑—ã: $FINAL_SIZE –±–∞–π—Ç"
    
    if [ "$FINAL_SIZE" -gt 1000000 ]; then
        echo "‚úÖ –ë–∞–∑–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–æ–ª—å—à–∞—è - –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é"
    else
        echo "‚ö†Ô∏è –ë–∞–∑–∞ –º–∞–ª–µ–Ω—å–∫–∞—è - –≤–æ–∑–º–æ–∂–Ω–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
        sleep 2
    fi
fi

# üöÄ –ó–ê–ü–£–°–ö N8N
echo "üöÄ –ó–∞–ø—É—Å–∫ n8n —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö..."
echo "   –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∞–∑–∞: $DB_SQLITE_DATABASE"
echo "   –ö–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
echo "   –≠–∫—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω"

exec n8n start 